{% extends "dashboard/base.html" %}
{% load static %}

{% block content %}
<div class="body-wrapper-inner">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card w-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>Product List</h2>
                            <button data-url="{% url 'add_product' %}" class="btn btn-success updateproductBtn">Add Product</button>
                        </div>

                        <div class="table-responsive">
                            <table id="producttable" class="table table-striped table-hover">
                                <thead class="table">
                                    <tr>
                                        <th>#</th>
                                        <th>Image</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            {% if product.product_image %}
                                            <img src="{{ product.product_image.url }}" width="50" height="50">
                                            {% else %}
                                            <img src="{% static 'dashboard/images/no-image.png' %}" width="50" height="50">
                                            {% endif %}
                                        </td>
                                        <td>{{ product.name }}</td>
                                        <td>{{ product.description|safe }}</td>
                                        <td>${{ product.price }}</td>
                                        <td>{{ product.stock }}</td>
                                        <td>{{ product.is_active|yesno:"Yes,No" }}</td>
                                        <td>
                                           <button class="btn btn-primary btn-sm viewProductBtn" data-url="{% url 'product_view' product.id %}">View</button>
                                            <button class="btn btn-warning btn-sm updateproductBtn" data-url="{% url 'product_update' product.id %}" >Update</button>
                                            <button class="btn btn-danger btn-sm updateproductBtn" data-url="{% url 'product_delete' product.id %}" >Delete</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">No products available.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination (optional) -->
                        {% if is_paginated %}
                        <nav>
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                                {% endif %}
                                {% for num in paginator.page_range %}
                                <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                                {% endfor %}
                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal for AJAX Product View -->
<div class="modal fade" id="productViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0" id="productModalBody">
        <!-- Product view page will load here -->
      </div>
    </div>
  </div>
</div>




{% endblock %}
{% block script %} 
<!-- ✅ CKEditor 5 Classic Build (CDN) -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
    // Reusable CKEditor initializer
    function initCKEditor() {
        const textarea = document.querySelector('#id_description'); // your textarea ID
        if (textarea) {
            // Destroy existing instance if any (prevent duplicates)
            if (textarea.ckeditorInstance) {
                textarea.ckeditorInstance.destroy()
                    .catch(error => console.error(error));
            }

            ClassicEditor.create(textarea, {
                toolbar: [
                    'heading', '|',
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'bulletedList', 'numberedList', '|',
                    'link', 'blockQuote', '|',
                    'undo', 'redo'
                ]
            }).then(editor => {
                textarea.ckeditorInstance = editor; // store instance
            }).catch(error => {
                console.error('Error initializing CKEditor:', error);
            });
        }
    }

    // Initialize CKEditor on page load (for static forms)
    document.addEventListener("DOMContentLoaded", function() {
        initCKEditor();
    });

    $(document).ready(function() {
        // Initialize DataTable
        $('#producttable').DataTable({
            "pageLength": 20,
            "lengthMenu": [10, 20, 30, 40, 50],
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "columnDefs": [
                {"orderable": false, "targets": [1, 7]}  // Image & Actions columns not sortable
            ],
            "language": {
                "search": "Filter Products:"
            }
        });

        // AJAX View Product (unchanged)
        $('.viewProductBtn').on('click', function() {
            var viewUrl = $(this).data('url');
            $.ajax({
                url: viewUrl,
                type: 'GET',
                success: function(response) {
                    var content = $(response).find('.body-wrapper-inner').html();
                    $('#productModalBody').html(content);
                    $('#productViewModal').modal('show');
                },
                error: function() {
                    alert('Error loading product details.');
                }
            });
        });

        // AJAX Update Product (modified to init CKEditor)
        $('.updateproductBtn').on('click', function() {
            var viewUrl = $(this).data('url');
            $.ajax({
                url: viewUrl,
                type: 'GET',
                success: function(response) {
                    var content = $(response).find('.body-wrapper-inner').html();
                    $('#productModalBody').html(content);
                    $('#productViewModal').modal('show');

                    // ✅ Initialize CKEditor on dynamically loaded form
                    initCKEditor();
                },
                error: function() {
                    alert('Error loading product details.');
                }
            });
        });
    });
</script>
{% endblock script %}


